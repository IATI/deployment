---
- hosts: datastore-dev
  remote_user: root
  gather_facts: false

  environment:
    DATABASE_URL: postgres:///iati_datastore


  tasks:

  - name: install python 2
    raw: test -e /usr/bin/python || (apt -y update && apt install -y python-minimal)

  - name: Create a datastore user
    user:
      name: datastore
      comment: "Datastore Account"
      createhome: yes

  - name: Install Datastore dependencies
    apt:
      name: "{{ item }}"
      state: present
      update_cache: yes
    with_items:
       - git
       - postgresql
       - redis-server
       - python-pip
       - libpq-dev
       - libxml2-dev
       - libxslt-dev
       - python-dev
       - libevent-dev
       - apache2
       - libapache2-mod-wsgi

  - name: Enable mod_rewrite
    apache2_module:
      name: rewrite
      state: present

  - name: Clone the repository
    git:
      repo: https://github.com/IATI/IATI-Datastore.git
      dest: /home/datastore/IATI-Datastore
      update: yes

  - name: Install requirements via pip
    pip:
      chdir: /home/datastore/IATI-Datastore
      requirements: requirements.txt

  - name: Create postgres database 'iati_datastore'
    become: true
    become_user: postgres
    postgresql_db:
      name: iati_datastore

  - name: Set environment variable to link to the postgres database
    lineinfile:
      dest: /etc/environment
      line: "export DATABASE_URL=postgres:///iati_datastore"

  - name: Create postgres role for root user
    postgresql_user:
      db: iati_datastore
      name: root
    become: true
    become_user: postgres

  - name: Create the iati-datastore tables
    command: iati create_database

  - name: Start crawler to get source data
    command: iati crawl update

  - cron:
      name: "Start worker to download and index datafiles"
      special_time: reboot
      job: "sleep 10m; iati queue background"

  - cron:
      name: "Update source data with crawler"
      minute: "30"
      hour: "0-23/5"
      job: "iati crawl update"
